@using SentientTwitter.Data;
@using SentientTwitter.Pages.Components;
@using SentientTwitter.Services;
@inject IJSRuntime JsRuntime
@inject ModalService _modalService

<div class="position-fixed">
    <span>
        <i class="fas fa-angle-double-left" role="button" @onclick="ReturnToDashboard"></i>
    </span>
</div>

@*HEADER*@
<div class="offset-1 col-10 section-spacing d-flex flex-column flex-md-row justify-content-md-between align-items-md-center py-2 text-center text-md-start">
    <div class="flex-grow-1 mb-1 mb-md-0">
        <h1>
            @*<img src="../css/images/aeroicon.svg" height="40" width="50" />*@
            @Model.Name
        </h1>
        <h2 class="h6 fw-medium text-muted mb-0">
            @Model.Model - @Model.Id
        </h2>
    </div>
</div>

<div class="offset-1 col-10">
    <div class="row" style="height:45vh; display: flex;">

        @*INFO*@
        <div class="col-6" style="overflow-y:hidden;">
            <div class="card-styles" style="height:100%;">
                <div class="block-header block-header-default">
                    <h3 class="block-title">Item Details</h3>
                </div>

                <div class="mt-4">
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            Name
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                @Model.Name
                            </span>
                        </div>
                    </div>
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            Status
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                @Model.Status
                            </span>
                        </div>
                    </div>
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            Live
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                @Model.IsLive
                            </span>
                        </div>
                    </div>
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            Model
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                @Model.Model
                            </span>
                        </div>
                    </div>
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            Serial
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                1A5D8FG1H3TJ9STG5S
                            </span>
                        </div>
                    </div>
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            In Service Date
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                @DateTime.Now.AddDays(-643)
                            </span>
                        </div>
                    </div>
                    <div class="row textClass justify-content-between">
                        <div class="col-4">
                            Est Expiry Date
                        </div>
                        <div class="col-6">
                            <span class="text-details text-muted">
                                @DateTime.Now.AddDays(782)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6" style="overflow:hidden;">
            <div class="card-styles" style="height:100%;">
                <div class="block-header block-header-default">
                    <h3 class="block-title">Availability</h3>
                </div>

                <div class="block-content block-content-full flex-grow-1 d-flex align-items-center">
                    <canvas id="chartjs-pie" width="1030" height="515" style="display: block; box-sizing:border-box; height: 515px; width: 1030px;"></canvas>
                </div>
            </div>
        </div>

    </div>

</div>

<div class="offset-1 col-10">

    @*CURRENT STATUS*@
    <div class="row">
        <div class="col-12" style="overflow: hidden;">
            <div class="card-styles" style="height:100%;">

                <div class="block-header block-header-default bg-info-light">
                    <h3 class="block-title text-info">Snapshot</h3>
                </div>

                <div class="block-content block-content-full flex-grow-1 d-flex align-items-center">
                    <div class="col-6 text-center textClass">
                        <p>No active errors!</p>
                    </div>

                    <div class="col-6">
                        <div class="mt-4">
                            <div class="row textClass justify-content-between">
                                <div class="col-4">
                                    Capacity
                                </div>
                                <div class="col-6 text-break">
                                    <span class="col-6 text-break text-details text-muted">
                                        @Model.Battery.Capacity
                                    </span>
                                </div>
                            </div>

                            <div class="row textClass justify-content-between">
                                <div class="col-4">
                                    Cycles
                                </div>
                                <div class="col-6 text-break">
                                    <span class="col-6 text-break text-details text-muted">
                                        @Model.Battery.Cycles
                                    </span>
                                </div>
                            </div>

                            <div class="row textClass justify-content-between">
                                <div class="col-4">
                                    Charge
                                </div>
                                <div class="col-6 text-break">
                                    <span class="col-6 text-break text-details text-muted">
                                        @Model.Battery.Charge %
                                    </span>
                                </div>
                            </div>

                            <div class="row textClass justify-content-between">
                                <div class="col-4">
                                    Battery Status
                                </div>
                                <div class="col-6 text-break">
                                    <span class="col-6 text-break text-details text-muted">
                                        @Model.Battery.Status
                                    </span>
                                </div>
                            </div>

                            <div class="row textClass justify-content-between">
                                <div class="col-4">
                                    ID
                                </div>
                                <div class="col-6 text-break">
                                    <span class="col-6 text-break text-details text-muted">
                                        @Model.Battery.Id
                                    </span>
                                </div>
                            </div>

                            <div class="row textClass justify-content-between">
                                <div class="col-4">
                                    Owner
                                </div>
                                <div class="col-6 text-break">
                                    <span class="col-6 text-break text-details text-muted">
                                        @Model.Battery.OwnerId
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row">

        @*NODES*@
        <div class="col-3" style="justify-content: space-between; display: flex; flex-direction: column;">
            <div class="card-styles">

                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        Availability Score
                    </h3>
                </div>

                <h1 class="block-content block-content-full flex-grow-1 d-flex justify-content-center">
                    73%
                </h1>
            </div>

            <div class="card-styles">

                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        Error Count
                    </h3>
                </div>

                <h1 class="block-content block-content-full flex-grow-1 d-flex justify-content-center">
                    17
                </h1>
            </div>
        </div>

        @*BATTERY HISTORY*@
        <div class="col-9">
            <div class="card-styles">

                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        Battery History
                    </h3>
                </div>

                <h1 class="block-content block-content-full flex-grow-1 d-flex align-items-center">
                    <canvas id="chartjs-battery" width="1030" height="515" style="display: block; box-sizing:border-box; height: 515px; width: 1030px;"></canvas>
                </h1>
            </div>
        </div>

    </div>

    @*RECORDS*@
    <div class="row">

        <div class="col-12">
            <div class="card-styles">

                <div class="block-header block-header-default">
                    <div class="block-title block-options space-x-1 textClass col-6">
                        Records
                    </div>
                </div>

                <div class="block-options space-x-1 textClass" style="width: 100%; text-align: right;">
                    <button @onclick="(() => {IsSearchVisible = !IsSearchVisible;})" type="button" class="btn btn-sm btn-alt-secondary js-class-toggle-enabled" data-toggle="class-toggle" data-target="#one-dashboard-search-orders" data-class="d-none">
                        <i class="fa fa-search"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-md-end dropdown-menu-end fs-sm" aria-labelledby="dropdown-recent-orders-filters">
                        @foreach (var status in Enum.GetValues<HealthStatus>())
                        {
                            <a @onclick="(() => {FilterStatus = status;})" class="dropdown-item fw-medium d-flex align-items-center justify-content-between" href="javascript:void(0)">
                                @status
                                <span class="badge bg-primary rounded-pill">235</span>
                            </a>
                        }
                    </div>
                </div>

                @if (AllRecords.Any())
                {
                    <SentientTwitter.Pages.Components.DataTable Titem="FlightRecord" AllItems="AllRecords" Callback="ShowMessageModal" IsSearchVisible="IsSearchVisible"></SentientTwitter.Pages.Components.DataTable>
                }

            </div>
        </div>

    </div>
</div>

<style>
    canvas {
        max-height: 30vh;
    }

    .form-control.form-control-date {
        padding: 0;
    }

    .dot {
        height: 25px;
        width: 25px;
        background-color: #198754;
        border-radius: 50%;
        display: inline-block;
    }

    .text-details {
        font-size: 15px;
        font-style: italic;
    }

    .block-title {
        flex: 1 1 auto;
        min-height: 1.75rem;
        margin: 0;
        font-size: .875rem;
        font-weight: 600;
        line-height: 1.75rem;
        text-transform: uppercase;
        letter-spacing: .0625rem;
    }

    .block-content.block-content-full {
        padding-bottom: 1.25rem;
    }

    .block-content {
        transition: opacity .25s ease-out;
        width: 100%;
        margin: 0 auto;
        padding: 1.25rem 1.25rem 1px;
        overflow-x: visible;
    }

        .block-content.block-rounded > .block-header, .block.block-rounded > .nav-tabs {
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }

    .block-header-default {
        background-color: #f6f7f9;
    }

    .block-title {
        flex: 1 1 auto;
        min-height: 1.75rem;
        margin: 0;
        font-size: .875rem;
        font-weight: 600;
        line-height: 1.75rem;
        text-transform: uppercase;
        letter-spacing: .0625rem;
        color: #334155;
    }

    .block-header {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: 0.625rem 1.25rem;
        transition: opacity 3s ease-out;
    }

    .empty-section-spacing {
        margin: 50px 0 50px 0;
    }

    .textClass {
        font-family: 'Open Sans', sans-serif;
        padding: 5px 10px 5px 10px;
        border-radius: 0rem;
        align-items: center;
        margin: 0;
    }

    .card-styles {
        border-radius: 0.3rem;
        background: #ffffff;
        box--moz-box-shadow: 0 1px 2px rgb(214 219 226 / 50%), 0 1px 2px rgb(214 219 226 / 50%);
        margin-top: 25px;
        margin-bottom: 25px;
    }

    .loader-styles {
        margin: auto;
        padding: 50px;
    }

    .rounded-pill {
        border-radius: 50rem !important;
    }

    .bg-success-light {
        background-color: #e0edcf !important;
    }

    .text-success {
        color: #65a30d !important;
    }

    .text-success {
        --bs-text-opacity: 1;
        color: rgba(var(--bs-success-rgb), var(--bs-text-opacity)) !important;
    }

    .text-info {
        --bs-text-opacity: 1;
        color: rgba(var(--bs-info-rgb), var(--bs-text-opacity)) !important;
    }

    .text-info {
        color: #0891b2 !important;
    }

    .bg-info-light {
        background-color: #cee9f0 !important;
    }

    .text-warning {
        color: #ea580c !important;
    }

    .bg-warning-light {
        background-color: #fbdece !important;
    }

    .availability-spacing {
        margin-top 30px;
        height: 45vh;
        display: flex;
    }

    .section-spacing {
        margin-top: 50px;
        margin-bottom: 50px;
    }
</style>

@code {

    [Parameter]
    public TweetModel Model { get; set; }

    [Parameter]
    public Action<bool> Callback { get; set; }

    public bool IsSearchVisible;
    public HealthStatus FilterStatus;

    private IJSObjectReference ChartsModule { get; set; }
    public List<ChartData> PieChartData { get; set; }
    public List<ChartData> BarChartData { get; set; }
    public Decimal[] Percentages { get; set; }

    public List<FlightRecord> AllRecords { get; set; } = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Timespan
        Random random = new Random();
        TimeSpan start = TimeSpan.FromHours(7);
        TimeSpan end = TimeSpan.FromHours(11);
        int maxMinutes = (int)((end - start).TotalMinutes);

        for (int i = 0; i < 10000; i++)
        {
            int minutes = random.Next(maxMinutes);
            TimeSpan t = start.Add(TimeSpan.FromMinutes(minutes));

            var newRecord = new FlightRecord()
                {
                    Id = Guid.NewGuid(),
                    TweetId = Guid.NewGuid(),
                    Duration = t,
                    LocationX = 39.72738M,
                    LocationY = 72.11786M,
                    Status = HealthStatus.Healthy,
                    Message = "Test Message"
                };

            AllRecords.Add(newRecord);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            try
            {
                ChartsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", new CancellationToken(), "./js/GeneratedJS/ItemCharts.js");

                RenderCharts();
            }
            catch (Exception ex)
            {
                // log error
            }
        }
    }

    public async void RenderCharts()
    {
        try
        {
            // Dummy Chart Data
            List<int> healthy = new();
            List<int> unhealthy = new();
            List<DateTime> dates = new();

            Random randomNum = new Random();

            var healthyPercentage = randomNum.Next(100);
            var unhealthyPercentage = 100 - healthyPercentage;

            Percentages = new decimal[] { healthyPercentage, unhealthyPercentage, 0 };

            for (int i = 0; i < 7; i++)
            {
                dates.Add(DateTime.Now.AddDays(i));

                healthy.Add(randomNum.Next(100));
                unhealthy.Add(randomNum.Next(100));
            }

            var formattedDates = dates.Select(x => x.ToString("MM/dd/yyyy")).ToArray();

            await ChartsModule.InvokeVoidAsync("RenderCharts", new CancellationToken(), formattedDates, healthy.ToArray(), unhealthy.ToArray(), Percentages);
        }
        catch (Exception ex)
        {
            // log error
        }
    }

    public void ShowMessageModal<FlightRecord>(FlightRecord record)
    {
        try
        {
            _modalService.Show<FlightRecord, bool>($"Flight Details", "modal-tiny", true, typeof(SentientTwitter.Pages.Components.FlightRecordModal), record, callback =>
            {
                // blah
                var test = 123;
            });

        }
        catch (Exception ex)
        {
            // err
            var test2 = 123;
        }
    }

    public void ReturnToDashboard()
    {
        Callback?.Invoke(false);
    }
}
